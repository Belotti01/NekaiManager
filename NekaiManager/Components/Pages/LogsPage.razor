@page "/Logs"
@using System.Diagnostics
@using Nekai.Common
@using NekaiManager.Components.Components
<PageTitle>Logs</PageTitle>

<MudStack Row>
    <OpenDirectoryButton Disabled="@(SelectedLogDirectory is null)" Directory="@SelectedLogDirectory?.Path" />
    <MudSelect Disabled="@(!LogDirectories.Any())" Label="Choose a Program" T="LogDirectory" ValueChanged="@LoadLogs">
        @foreach(var directory in LogDirectories)
        {
            <MudSelectItem Value="directory">@directory.Name</MudSelectItem>
        }
    </MudSelect>
    <MudIconButton Icon="@Icons.Material.Filled.Refresh" OnClick="@RefreshLogDirectories" />
</MudStack>

<MudPaper Class="mt-4">
    <MudDataGrid @Loading="@Loading" Groupable Items="@LoadedLogs" AllowUnsorted Dense Hover ColumnResizeMode="ResizeMode.Column">
        <ToolBarContent>
            <MudButton StartIcon="@Icons.Material.Filled.Refresh" OnClick="@(() => LoadLogs(SelectedLogDirectory))">
                Refresh
            </MudButton>
            <MudSelect Class="mx-10" T="LogLevel" ValueChanged="@_UpdateMinimumLogLevel" Label="Minimum Log Level">
                @foreach(var logLevel in Enum.GetValues<LogLevel>())
                {
                    <MudSelectItem Value="logLevel">@logLevel</MudSelectItem>
                }
            </MudSelect>
            <MudCheckBox @bind-Value="@ShowMachineName">Show Machine Name</MudCheckBox>
        </ToolBarContent>
            
        <PagerContent>
            <MudDataGridPager T="Log"></MudDataGridPager>
        </PagerContent>

        <Columns>
            <TemplateColumn>
                <CellTemplate>
                    <MudIconButton Icon="@Icons.Material.Filled.OpenInNew" OnClick="@(() => context.Item?.File.Open())" />
                </CellTemplate>
            </TemplateColumn>
            @if(ShowMachineName)
            {
                <PropertyColumn Sortable="true" Property="x => x.Data.MachineName" Title="Machine Name"/>
            }
            <PropertyColumn Sortable="true" Property="x => x.Data.TimeStamp" Title="Date"/>
            <PropertyColumn Sortable="true" Property="x => x.Data.LogType" Title="Severity"/>
            <PropertyColumn Property="x => x.Data.Message" Title="Message"/>
        </Columns>
    </MudDataGrid>
</MudPaper>

@code {
    public LogLevel MinimumLogLevel { get; set; } = LogLevel.Information;
    public bool ShowMachineName { get; set; } = false;
    public LogDirectory? SelectedLogDirectory { get; set; }
    public IEnumerable<Log> LoadedLogs { get; private set; } = [];
    public IEnumerable<LogDirectory> LogDirectories { get; private set; } = [];
    public bool Loading { get; private set; } = false;

    protected override async Task OnInitializedAsync()
    {
        RefreshLogDirectories();
    }
    
    public void RefreshLogDirectories()
    {
        LogDirectories = NekaiData.Directories.Logs
            .EnumerateDirectories(SearchOption.AllDirectories)
            // Exclude empty directories.
            .Where(x => Directory.EnumerateFiles(x, "*.json", SearchOption.AllDirectories).Any())
            .Select(x => new LogDirectory(PathString.Parse(x)));
    }

    public void LoadLogs(LogDirectory? path)
    {
        SelectedLogDirectory = path;
        if(SelectedLogDirectory is null)
            return;
        
        Loading = true;
        // Enumerate files.
        var logFiles = SelectedLogDirectory.Path
            .EnumerateFiles(SearchOption.AllDirectories, "*.json")
            .Select(x => new LogFile(PathString.Parse(x)));

        // Load logs from files and filter by log level.
        LoadedLogs = logFiles
            .SelectMany(file => file.LoadLogs())
            .Where(x => x.Data.LogType >= MinimumLogLevel);
        Loading = false;
    }

    private void _UpdateMinimumLogLevel(LogLevel toLogLevel)
    {
        if(MinimumLogLevel == toLogLevel)
            return;
        
        MinimumLogLevel = toLogLevel;
        LoadLogs(SelectedLogDirectory);
    }

    public class LogDirectory(PathString path)
    {
        public PathString Path { get; } = path;
        public string Name { get; } = path.GetFileOrDirectoryName().ToString();
        public override string ToString() => Name;
    }

    public class LogFile(PathString path)
    {
        public PathString Path { get; } = path;
        
        public Log[] LoadLogs()
        {
            var logs = NekaiLogs.Deserialize(Path);
            return logs.Select(x => new Log(this, x)).ToArray();
        }

        public Process? Open()
        {
            return Process.Start(new ProcessStartInfo
            {
                FileName = Path,
                UseShellExecute = true
            });
        }
    }

    public class Log(LogFile file, NekaiLog data)
    {
        public LogFile File { get; } = file;
        public NekaiLog Data { get; } = data;
    }
}