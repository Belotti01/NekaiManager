@page "/Logs"
@using System.Diagnostics
@using Nekai.Common
@using NekaiManager.Components.Components
<PageTitle>Logs</PageTitle>

<MudStack Row>
    <OpenDirectoryButton Disabled="@(SelectedLogDirectory is null)" Directory="@SelectedLogDirectory?.Path" />
    <MudSelect Disabled="@(!LogDirectories.Any())" Label="Choose a Program" T="LogDirectory" ValueChanged="@LoadLogFiles">
        @foreach(var directory in LogDirectories)
        {
            <MudSelectItem Value="directory">@directory.Name</MudSelectItem>
        }
    </MudSelect>
    <MudIconButton Icon="@Icons.Material.Filled.Refresh" OnClick="@RefreshLogDirectories" />
</MudStack>

<MudPaper Class="mt-4">
    <MudDataGrid @Loading="@Loading" Groupable Items="@LoadedLogs" AllowUnsorted Dense Hover ColumnResizeMode="ResizeMode.Column">
        <ToolBarContent>
            <MudButton StartIcon="@Icons.Material.Filled.Refresh" OnClick="@(() => LoadLogFiles(SelectedLogDirectory))">
                Refresh
            </MudButton>
            <MudSelect Class="mx-10" T="LogLevel" ValueChanged="@_UpdateMinimumLogLevel" Label="Minimum Log Level">
                @foreach(var logLevel in Enum.GetValues<LogLevel>())
                {
                    <MudSelectItem Value="logLevel">@logLevel</MudSelectItem>
                }
            </MudSelect>
            <MudCheckBox @bind-Value="@ShowMachineName">Show Machine Name</MudCheckBox>
        </ToolBarContent>
            
        <PagerContent>
            <MudDataGridPager T="Log"></MudDataGridPager>
        </PagerContent>

        <Columns>
            <TemplateColumn>
                <CellTemplate>
                    <MudIconButton Icon="@Icons.Material.Filled.OpenInNew" OnClick="@(() => OpenLogFile(context.Item?.Path))"/>
                </CellTemplate>
            </TemplateColumn>
            @if(ShowMachineName)
            {
                <PropertyColumn Sortable="true" Property="x => x.Data.MachineName" Title="Machine Name"/>
            }
            <PropertyColumn Sortable="true" Property="x => x.Data.TimeStamp" Title="Date"/>
            <PropertyColumn Sortable="true" Property="x => x.Data.LogType" Title="Severity"/>
            <PropertyColumn Property="x => x.Data.Message" Title="Message"/>
        </Columns>
    </MudDataGrid>
</MudPaper>

@code {
    public LogLevel MinimumLogLevel { get; set; } = LogLevel.Information;
    public bool ShowMachineName { get; set; } = false;
    public LogDirectory? SelectedLogDirectory { get; set; }
    public IEnumerable<Log> LoadedLogs { get; private set; } = [];
    public IEnumerable<LogFile> SelectedLogFiles { get; private set; } = [];
    public IEnumerable<LogDirectory> LogDirectories { get; private set; } = [];
    public bool Loading { get; private set; } = false;

    protected override async Task OnInitializedAsync()
    {
        RefreshLogDirectories();
    }
    
    public void RefreshLogDirectories()
    {
        LogDirectories = EnumerateLogDirectories();
    }

    public static IEnumerable<LogDirectory> EnumerateLogDirectories()
    {
        return NekaiData.Directories.Logs
            .EnumerateDirectories(SearchOption.AllDirectories)
            // Exclude empty directories.
            .Where(x => Directory.EnumerateFiles(x, "*.json", SearchOption.AllDirectories).Any())
            .Select(x => new LogDirectory(PathString.Parse(x)));
    }
    
    public IEnumerable<Log> GetLoadedLogs()
    {
        var logs = SelectedLogFiles
            .SelectMany(file => file.LoadLogs())
            .Where(x => x.Data.LogType >= MinimumLogLevel);
        return logs;
    }

    public void UpdateLoadedLogs()
    {
        Loading = true;
        LoadedLogs = GetLoadedLogs().ToList();
        Loading = false;
    }
    
    public void LoadLogFiles(LogDirectory? path)
    {
        SelectedLogDirectory = path;
        if(SelectedLogDirectory is null)
        {
            SelectedLogFiles = [];
            return;
        }
        var logFiles = SelectedLogDirectory.Path.EnumerateFiles(SearchOption.AllDirectories, "*.json");
        var logs = logFiles
            .Select(x => new LogFile(PathString.Parse(x)));
        
        SelectedLogFiles = logs;
        UpdateLoadedLogs();
    }

    public void OpenLogFile(PathString? filePath)
    {
        if(filePath is null)
            return;
        
        _ = Process.Start(new ProcessStartInfo
        {
            FileName = filePath,
            UseShellExecute = true
        });
    }

    private void _UpdateMinimumLogLevel(LogLevel toLogLevel)
    {
        if(MinimumLogLevel == toLogLevel)
            return;
        
        MinimumLogLevel = toLogLevel;
        UpdateLoadedLogs();
    }

    public class LogDirectory(PathString path)
    {
        public PathString Path { get; } = path;
        public string Name { get; } = path.GetFileOrDirectoryName().ToString();
        public override string ToString() => Name;
    }

    public class LogFile(PathString path)
    {
        public PathString Path { get; } = path;
        public Log[] LoadLogs()
        {
            var logs = NekaiLogs.Deserialize(Path);
            return logs.Select(x => new Log(Path, x)).ToArray();
        }
    }

    public class Log(PathString path, NekaiLog data)
    {
        public PathString Path { get; } = path;
        public NekaiLog Data { get; } = data;
    }
}