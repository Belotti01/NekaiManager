@page "/Logs"
@using Nekai.Common
@using NekaiManager.Components.Components
<PageTitle>Logs</PageTitle>

<MudStack Row>
    <OpenDirectoryButton Disabled="@(SelectedLogDirectory is null)" Directory="@SelectedLogDirectory?.Path" />
    <MudSelect Disabled="@(!LogDirectories.Any())" Label="Choose a Program" T="LogDirectory" ValueChanged="x => LoadLogs(x)">
        @foreach(var directory in LogDirectories)
        {
            <MudSelectItem Value="directory">@directory.Name</MudSelectItem>
        }
    </MudSelect>
</MudStack>

<MudDataGrid Items="Logs" AllowUnsorted Dense Hover>
    <PagerContent>
        <MudDataGridPager T="NekaiLog"></MudDataGridPager>
    </PagerContent>
    
    <Columns>
        <PropertyColumn Sortable="true" Property="x => x.TimeStamp" Title="Date"/>
        <PropertyColumn Sortable="true" Property="x => x.LogType" Title="Severity"/>
        <PropertyColumn Property="x => x.Message" Title="Message"/>
    </Columns>
</MudDataGrid>

@code {
    public LogDirectory? SelectedLogDirectory { get; set; }
    public List<NekaiLog> Logs { get; private set; } = [];
    public IEnumerable<LogDirectory> LogDirectories { get; private set; } = [];

    protected override async Task OnInitializedAsync()
    {
        LogDirectories = EnumerateLogDirectories();
    }

    public static IEnumerable<LogDirectory> EnumerateLogDirectories()
    {
        return NekaiData.Directories.Logs
            .EnumerateDirectories(SearchOption.AllDirectories)
            .Select(x => new LogDirectory(PathString.Parse(x)));
    }
    
    public void LoadLogs(LogDirectory path)
    {
        SelectedLogDirectory = path;
        if(SelectedLogDirectory is null)
        {
            Logs = [];
            return;
        }
        Logs = NekaiLogs.DeserializeAll(SelectedLogDirectory.Path, true);
    }
    
    public class LogDirectory(PathString path)
    {
        public PathString Path { get; } = path;
        public string Name { get; } = path.GetFileOrDirectoryName().ToString();
    }
}