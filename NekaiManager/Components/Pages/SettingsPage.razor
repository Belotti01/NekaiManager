@page "/Settings"
@using System.Diagnostics
@using System.Diagnostics.CodeAnalysis
@using Microsoft.AspNetCore.Html
@using Nekai.Common
@using NekaiManager.Components.Components
@using NekaiManager.Data.DTOs
<PageTitle>Settings</PageTitle>

<MudCard>
    <MudCardHeader>
        <MudText Typo="Typo.h5">General Settings</MudText>
    </MudCardHeader>
    <MudCardContent>
        <EditForm Model="@_Settings" OnValidSubmit="SaveSettings">
            <DataAnnotationsValidator />

            <MudStack Row>
                <OpenDirectoryButton Directory="@NekaiGeneralConfiguration.Singleton.FilePath!.GetContainingDirectory()" />
                <MudTextField ReadOnly Label="Configuration File Path" Value="NekaiGeneralConfiguration.Singleton.FilePath" />
            </MudStack>
            
            <MudCheckBox @bind-Value="@_Settings.PreferDarkMode">Prefer Dark Mode</MudCheckBox>

            <MudStack Row>
                <MudButton ButtonType="ButtonType.Submit">Save</MudButton>
                <MudButton OnClick="@_Reset">Undo</MudButton>
            </MudStack>
        </EditForm>
    </MudCardContent>
</MudCard>

@code {
    [Inject]
    public ISnackbar Snackbar { get; set; } = null!;
    private SettingsDto _Settings { get; set; } = new();

    public SettingsPage()
    {
        _Reset();
    }
    
    private IEnumerable<string> _Validate()
    {
        return [];
    }

    private void _Reset()
    {
        _Settings.PreferDarkMode = NekaiGeneralConfiguration.Singleton.PreferDarkMode;
    }
    
    public void SaveSettings()
    {
        // Validation
        var errors = _Validate().ToList();
        if(errors.Any())
        {
            string errorMessage = string.Join("\n", errors);
            Snackbar.Add(errorMessage, Severity.Error);
            return;
        }
        
        // Save changes
        NekaiApp.Configuration.PreferDarkMode = _Settings.PreferDarkMode;
        var result = NekaiGeneralConfiguration.Singleton.TrySerialize();
        if(result.IsSuccessful())
        {
            Snackbar.Add("Settings saved successfully.", Severity.Success);
        }
        else
        {
            Snackbar.Add($"Failed to save settings: {result.GetMessage()}.", Severity.Error);
        }
    }
}