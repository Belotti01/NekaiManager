@page "/Settings"
@using Nekai.Common
@using NekaiManager.Components.Components
@using NekaiManager.Data.DTOs
<PageTitle>Settings</PageTitle>

<MudCard>
    <MudCardHeader>
        <MudText Typo="Typo.h5">General Settings</MudText>
    </MudCardHeader>
    <MudCardContent>
        <EditForm Model="@_Settings" OnValidSubmit="SaveSettings">
            <DataAnnotationsValidator />
            <MudStack>
                <MudStack Row>
                    <OpenDirectoryButton Directory="@NekaiGeneralConfiguration.Singleton.FilePath!.GetContainingDirectory()" />
                    <MudTextField ReadOnly Label="Configuration File Path" Value="NekaiGeneralConfiguration.Singleton.FilePath" />
                </MudStack>
                
                <MudStack Row>
                    <MudSelect Label="Language" @bind-Value="@_Settings.PreferredLanguage">
                        @foreach(var language in Enum.GetValues<DisplayLanguage>())
                        {
                            <MudSelectItem Value="language">@language</MudSelectItem>
                        }
                    </MudSelect>
                </MudStack>
                
                <MudCheckBox @bind-Value="@_Settings.PreferDarkMode">Prefer Dark Mode</MudCheckBox>

                <MudStack Row>
                    <MudButton ButtonType="ButtonType.Submit">Save</MudButton>
                    <MudButton OnClick="@_Reset">Undo</MudButton>
                </MudStack>
            </MudStack>
        </EditForm>
    </MudCardContent>
</MudCard>

<MudCard Class="mt-2">
    <MudCardContent>
        <MudStack Row>
            <MudButton OnClick="ClearCache" StartIcon="@Icons.Material.Filled.Delete">Clear Cache (@(GetCacheSizeMb())MB)</MudButton>
        </MudStack>
    </MudCardContent>
</MudCard>

@code {
    [Inject]
    public ISnackbar Snackbar { get; set; } = null!;
    private SettingsDto _Settings { get; } = new();

    public SettingsPage()
    {
        _Reset();
    }
    
    private IEnumerable<string> _Validate()
    {
        return [];
    }

    private void _Reset()
    {
        _Settings.PreferDarkMode = NekaiGeneralConfiguration.Singleton.PreferDarkMode;
        _Settings.PreferredLanguage = NekaiGeneralConfiguration.Singleton.DefaultLanguage;
    }
    
    public void SaveSettings()
    {
        // Validation
        var errors = _Validate().ToList();
        if(errors.Any())
        {
            string errorMessage = string.Join("\n", errors);
            Snackbar.Add(errorMessage, Severity.Error);
            return;
        }
        
        // Save changes
        if(_Settings.PreferDarkMode != NekaiGeneralConfiguration.Singleton.PreferDarkMode)
        {
            Snackbar.Add("Reload the page to apply light/dark mode.", Severity.Info);
        }
        NekaiApp.Configuration.PreferDarkMode = _Settings.PreferDarkMode;
        NekaiApp.Configuration.DefaultLanguage = _Settings.PreferredLanguage;
        
        // Serialize
        var result = NekaiGeneralConfiguration.Singleton.TrySerialize();
        if(result.IsSuccessful())
        {
            Snackbar.Add("Settings saved successfully.", Severity.Success);
        }
        else
        {
            Snackbar.Add($"Failed to save settings: {result.GetMessage()}.", Severity.Error);
        }
    }

    public long GetCacheSizeMb()
    {
        var cacheDirectory = NekaiData.Directories.Temp;
        if(!cacheDirectory.IsExistingDirectory())
        {
            return 0;
        }
        
        var cacheFiles = cacheDirectory.EnumerateFiles(SearchOption.AllDirectories);
        long totalSize = cacheFiles.Sum(x => new FileInfo(x).Length);
        return totalSize / 1024 / 1024; // Return size in MB
    }

    public void ClearCache()
    {
        var cacheDirectory = NekaiData.Directories.Temp;
        bool isCacheEmpty = !cacheDirectory.IsExistingDirectory() 
                         || !cacheDirectory.EnumerateFiles(SearchOption.AllDirectories).Any();
        if(isCacheEmpty)
        {
            Snackbar.Add("Cache is empty.", Severity.Info);
            return;
        }

        var result = NekaiData.ClearOldTempFiles();
        if(result.IsSuccessful)
        {
            Snackbar.Add($"{result.Value} files deleted successfully.", Severity.Success);
        }
        else
        {
            Snackbar.Add($"Failed to clear cache: {result.Error.GetMessage()}", Severity.Warning);
            NekaiLogs.Program.Warning("Failed to clear cache: {error}.", result.Error.GetMessage());
        }
    }
}