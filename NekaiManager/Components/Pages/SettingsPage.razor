@page "/Settings"
@using Nekai.Common
@using NekaiManager.Components.Components
@using NekaiManager.Data.DTOs
<PageTitle>Settings</PageTitle>

<MudCard>
    <MudCardHeader>
        <MudText Typo="Typo.h5">General Settings</MudText>
    </MudCardHeader>
    <MudCardContent>
        <EditForm Model="@_Settings" OnValidSubmit="SaveSettings">
            <DataAnnotationsValidator />
            <MudStack>
                <MudStack Row>
                    <OpenDirectoryButton Directory="@NekaiGeneralConfiguration.Singleton.FilePath!.GetContainingDirectory()" />
                    <MudTextField ReadOnly Label="Configuration File Path" Value="NekaiGeneralConfiguration.Singleton.FilePath" />
                </MudStack>
                
                <MudStack Row>
                    <MudText>Language:</MudText>
                    <MudSelect Text="Language" @bind-Value="@_Settings.PreferredLanguage">
                        @foreach(var language in Enum.GetValues<DisplayLanguage>())
                        {
                            <MudSelectItem Value="language">@language</MudSelectItem>
                        }
                    </MudSelect>
                </MudStack>
                
                <MudCheckBox @bind-Value="@_Settings.PreferDarkMode">Prefer Dark Mode</MudCheckBox>

                <MudStack Row>
                    <MudButton ButtonType="ButtonType.Submit">Save</MudButton>
                    <MudButton OnClick="@_Reset">Undo</MudButton>
                </MudStack>
            </MudStack>
        </EditForm>
    </MudCardContent>
</MudCard>

@code {
    [Inject]
    public ISnackbar Snackbar { get; set; } = null!;
    private SettingsDto _Settings { get; } = new();

    public SettingsPage()
    {
        _Reset();
    }
    
    private IEnumerable<string> _Validate()
    {
        return [];
    }

    private void _Reset()
    {
        _Settings.PreferDarkMode = NekaiGeneralConfiguration.Singleton.PreferDarkMode;
        _Settings.PreferredLanguage = NekaiGeneralConfiguration.Singleton.DefaultLanguage;
    }
    
    public void SaveSettings()
    {
        // Validation
        var errors = _Validate().ToList();
        if(errors.Any())
        {
            string errorMessage = string.Join("\n", errors);
            Snackbar.Add(errorMessage, Severity.Error);
            return;
        }
        
        // Save changes
        if(_Settings.PreferDarkMode != NekaiGeneralConfiguration.Singleton.PreferDarkMode)
        {
            Snackbar.Add("Reload the page to apply light/dark mode.", Severity.Info);
        }
        NekaiApp.Configuration.PreferDarkMode = _Settings.PreferDarkMode;
        NekaiApp.Configuration.DefaultLanguage = _Settings.PreferredLanguage;
        
        // Serialize
        var result = NekaiGeneralConfiguration.Singleton.TrySerialize();
        if(result.IsSuccessful())
        {
            Snackbar.Add("Settings saved successfully.", Severity.Success);
        }
        else
        {
            Snackbar.Add($"Failed to save settings: {result.GetMessage()}.", Severity.Error);
        }
    }
}